Ansar Ahmed
ULTIMATE DESIGN TECHNOLOGY LLP
EE
1173919287
1173919287
Mumbai
ansar@mail.com



make parameter dynamic

and check pagination code sort all data this code sort current page data only
when i go to next page then it not return next sorted data it return constant data that belong to that page

we have google.html file write render function to render html file 
*********************







***************************888
check this api if i post 15 images first time then it post 15 images successfully 
like shows in terminal like this Found 1 face(s) in C:\Users\qccs\Desktop\Turnstile\media\facial_data\danish\michael-dam-mEZ3PoFGs_k-unsplash.jpg
--> processing image 14/15
Found 0 face(s) in C:\Users\qccs\Desktop\Turnstile\media\facial_data\danish\sub-admin-sites.png
--> processing image 15/15
Found 0 face(s) in C:\Users\qccs\Desktop\Turnstile\media\facial_data\danish\WhatsApp_Image_2024-06-04_at_11.41.39_AM_8.jpeg

but after i again post 15 images so it look like this in terminal 
Found 1 face(s) in C:\Users\qccs\Desktop\Turnstile\media\facial_data\danish\michael-dam-mEZ3PoFGs_k-unsplash_P8ae3Z8.jpg
--> processing image 27/30
Found 0 face(s) in C:\Users\qccs\Desktop\Turnstile\media\facial_data\danish\sub-admin-sites.png
--> processing image 28/30
Found 0 face(s) in C:\Users\qccs\Desktop\Turnstile\media\facial_data\danish\sub-admin-sites_SnDGbxe.png
--> processing image 29/30
Found 0 face(s) in C:\Users\qccs\Desktop\Turnstile\media\facial_data\danish\WhatsApp_Image_2024-06-04_at_11.41.39_AM_8.jpeg
--> processing image 30/30
Found 0 face(s) in C:\Users\qccs\Desktop\Turnstile\media\facial_data\danish\WhatsApp_Image_2024-06-04_at_11.41.39_AM_8_Y1t3Fmd.jpeg
--> encodings finalized
i think again it post 30 images first 15 and 15 images now i give total 30 images and it increase 45,55 like this
if i give 15 images then only post 15 not post including previous ones
this is api "import pickle
from imutils import paths
import face_recognition
import pickle
import cv2
from .serializers import FacialImageDataSerializer

class FacialDataApi(APIView):
    def post(self, request):
        serializer = FacialImageDataSerializer(data=request.data)
        if serializer.is_valid():
            email = serializer.validated_data['email']
            images = serializer.validated_data['facial_data']
            try:
                user = UserEnrolled.objects.get(email=email)
                for image in images:
                    user.facial_data = image
                    user.save()
                    
                if images:
                    random_image = random.choice(images)
                    user.picture = random_image
                    user.save()
                    
            except UserEnrolled.DoesNotExist:
                return Response("User not found", status=status.HTTP_404_NOT_FOUND)
            user_folder = os.path.join(settings.MEDIA_ROOT, 'facial_data', str(user.name))
            self.update_pickle(user_folder)

            return Response("Images uploaded and facial data updated successfully", status=status.HTTP_200_OK)

        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

    def update_pickle(self, user_folder):
        pickle_file_path = os.path.join(user_folder, 'encodings.pickle')

        imagePaths = list(paths.list_images(user_folder))

        knownEncodings = []
        knownNames = []

        print(f"Total images found: {len(imagePaths)}")

        for (i, imagePath) in enumerate(imagePaths):
            print(f"--> processing image {i + 1}/{len(imagePaths)}")
            name = os.path.basename(os.path.dirname(imagePath))

            image = cv2.imread(imagePath)
            rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)

            boxes = face_recognition.face_locations(rgb, model="hog")
            encodings = face_recognition.face_encodings(rgb, boxes)

            print(f"Found {len(encodings)} face(s) in {imagePath}")

            for encoding in encodings:
                knownEncodings.append(encoding)
                knownNames.append(name)

        #print('--> encodings:', knownEncodings)
        # print('--> names:', knownNames)

        data = {"encodings": knownEncodings, "names": knownNames}
        with open(pickle_file_path, 'wb') as f:
            pickle.dump(data, f)

        print('--> encodings finalized') 
        "
this is seralizer "class FacialImageDataSerializer(serializers.Serializer):
email = serializers.EmailField()
facial_data = serializers.ListField(child=serializers.ImageField())"



****************


import pickle
from imutils import paths
import face_recognition
import cv2
from django.conf import settings
from rest_framework.response import Response
from rest_framework import status
from .serializers import FacialImageDataSerializer

class FacialDataApi(APIView):
    def post(self, request):
        serializer = FacialImageDataSerializer(data=request.data)
        if serializer.is_valid():
            email = serializer.validated_data['email']
            images = serializer.validated_data['facial_data']
            try:
                user = UserEnrolled.objects.get(email=email)
                user_folder = os.path.join(settings.MEDIA_ROOT, 'facial_data', str(user.name))
                
                # Save new images to the user's folder
                for image in images:
                    image_path = os.path.join(user_folder, image.name)
                    image.save(image_path, image.file)
                
                # Update the user's picture if images were provided
                if images:
                    random_image = random.choice(images)
                    user.picture = random_image
                    user.save()
                
                # Update the pickle file with new encodings
                self.update_pickle(user_folder, images)
                
                return Response("Images uploaded and facial data updated successfully", status=status.HTTP_200_OK)
            except UserEnrolled.DoesNotExist:
                return Response("User not found", status=status.HTTP_404_NOT_FOUND)
        return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)

    def update_pickle(self, user_folder, new_images):
        pickle_file_path = os.path.join(user_folder, 'encodings.pickle')

        # Load existing encodings if the pickle file exists
        known_encodings = []
        known_names = []
        if os.path.exists(pickle_file_path):
            with open(pickle_file_path, 'rb') as f:
                data = pickle.load(f)
                known_encodings = data['encodings']
                known_names = data['names']

        # Process new images
        for image in new_images:
            image_path = os.path.join(user_folder, image.name)
            
            image = cv2.imread(image_path)
            rgb = cv2.cvtColor(image, cv2.COLOR_BGR2RGB)

            boxes = face_recognition.face_locations(rgb, model="hog")
            encodings = face_recognition.face_encodings(rgb, boxes)

            print(f"Found {len(encodings)} face(s) in {image_path}")

            for encoding in encodings:
                known_encodings.append(encoding)
                known_names.append(user.name)  # Assuming user.name is the name you want to associate with the encodings

        # Update the pickle file with new encodings
        data = {"encodings": known_encodings, "names": known_names}
        with open(pickle_file_path, 'wb') as f:
            pickle.dump(data, f)

        print('--> encodings finalized')